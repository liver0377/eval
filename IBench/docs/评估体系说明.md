# IBench è¯„ä¼°ä½“ç³»è¯´æ˜

## ğŸ“Š æ¦‚è¿°

IBench æä¾›ä¸¤ç§è¯„ä¼°æ¨¡å¼ï¼Œç”¨äºè¯„ä¼°å¯¹è¯æ¨¡å‹åœ¨ä¸åŒåœºæ™¯ä¸‹çš„è¡¨ç°ï¼š

1. **é»„é‡‘å†å²è¯„ä¼°** (Golden History Evaluation)
2. **åŠ¨æ€äº¤äº’è¯„ä¼°** (Dynamic Interactive Evaluation)

---

## ğŸ¯ ä¸¤ç§è¯„ä¼°æ¨¡å¼å¯¹æ¯”

### æ ¸å¿ƒå·®å¼‚

| ç»´åº¦ | é»„é‡‘å†å²è¯„ä¼° | åŠ¨æ€äº¤äº’è¯„ä¼° |
|------|------------|------------|
| **è¯„ä¼°å™¨** | `JsonContextEvaluator` | `DynamicInteractiveEvaluator` |
| **æ–‡ä»¶ä½ç½®** | `pipeline/json_context_evaluator.py` | `pipeline/dynamic_interactive_eval.py` |
| **è¾“å…¥æ•°æ®** | å®Œæ•´å¯¹è¯ï¼ˆæœ€åä¸€æ¡æ˜¯useræ¶ˆæ¯ï¼‰ | å®Œæ•´å¯¹è¯ï¼ˆæ‰€æœ‰userå’Œassistantæ¶ˆæ¯ï¼‰ |
| **ç”Ÿæˆå›å¤** | âœ… ç”Ÿæˆæœ€åä¸€æ¡assistantå›å¤ | âŒ ä¸ç”Ÿæˆï¼Œç›´æ¥è¯„ä¼°ç°æœ‰å›å¤ |
| **è¯„ä¼°å¯¹è±¡** | åªè¯„ä¼°ç”Ÿæˆçš„æœ€åä¸€æ¡å›å¤ | è¯„ä¼°æ¯ä¸€è½®çš„assistantå›å¤ |
| **è§„åˆ™é…ç½®** | `rule_list` (æ•°ç»„) | `rules` (å¯¹è±¡æ•°ç»„) |
| **è§„åˆ™ç²’åº¦** | å…¨å±€è§„åˆ™åˆ—è¡¨ | æ¯è½®è§„åˆ™åˆ—è¡¨ï¼ˆæ”¯æŒFIRST_N/N_thï¼‰ |
| **kwargsè¾“å‡º** | æ‰å¹³æ•°ç»„ï¼ˆå¯¹åº”rule_listï¼‰ | åµŒå¥—å¯¹è±¡ï¼ˆæŒ‰turn_idç»„ç»‡ï¼‰ |
| **ç”¨é€”** | æµ‹è¯•ç‰¹å®šä¸Šä¸‹æ–‡ä¸‹çš„å›å¤èƒ½åŠ› | è¯„ä¼°å®Œæ•´å¯¹è¯çš„è´¨é‡ |
| **ç¤ºä¾‹æ–‡ä»¶** | `examples/golden_history_input_example.json` | `examples/dynamic_interactive_input_example.json` |

---

## ğŸ“ é»„é‡‘å†å²è¯„ä¼° (JsonContextEvaluator)

### ç”¨é€”
æµ‹è¯•æ¨¡å‹åœ¨ç‰¹å®šå¯¹è¯ä¸Šä¸‹æ–‡ä¸­ç”Ÿæˆå›å¤çš„èƒ½åŠ›ã€‚

### rule_listæ ¼å¼è¯´æ˜

é»„é‡‘å†å²è¯„ä¼°çš„ `rule_list` æ”¯æŒä¸¤ç§æ ¼å¼ï¼š

#### 1. å­—ç¬¦ä¸²æ ¼å¼ï¼ˆç”¨äºsingle_turnè§„åˆ™ï¼‰

```json
"single_turn:sty:gratitude"
```

#### 2. å¯¹è±¡æ ¼å¼ï¼ˆç”¨äºmulti_turnè§„åˆ™ï¼Œéœ€è¦æŒ‡å®šNå‚æ•°ï¼‰

```json
{"rule": "multi_turn:N_th:gender", "N": 2}
```

**å®Œæ•´çš„rule_listç¤ºä¾‹ï¼š**
```json
{
  "rule_list": [
    "single_turn:sty:gratitude",
    "single_turn:sty:explain_filler",
    {"rule": "multi_turn:N_th:consult_subject", "N": 1},
    {"rule": "multi_turn:N_th:gender", "N": 2}
  ]
}
```

### Nå‚æ•°è¯¦è§£

#### å¯¹äº `multi_turn:N_th:xxx`
- **å«ä¹‰**ï¼šæ£€æŸ¥ç¬¬Nè½®çš„assistantå›å¤
- **ç¤ºä¾‹**ï¼š`{"rule": "multi_turn:N_th:gender", "N": 2}`
  - æ£€æŸ¥ç¬¬2è½®çš„assistantå›å¤æ˜¯å¦è¯¢é—®äº†æ€§åˆ«
  - å¦‚æœè¯¢é—®äº†ï¼Œè§¦å‘è§„åˆ™ï¼Œå¾—åˆ†=+1

#### å¯¹äº `multi_turn:FIRST_N:xxx`
- **å«ä¹‰**ï¼šæ£€æŸ¥å‰Nè½®ä¸­æ˜¯å¦æœ‰ä»»æ„ä¸€è½®è§¦å‘è§„åˆ™
- **ç¤ºä¾‹**ï¼š`{"rule": "multi_turn:FIRST_N:consult_subject", "N": 1}`
  - æ£€æŸ¥å‰1è½®ï¼ˆç¬¬1è½®ï¼‰æ˜¯å¦è¯¢é—®äº†å’¨è¯¢å¯¹è±¡
  - å¦‚æœè¯¢é—®äº†ï¼Œè§¦å‘è§„åˆ™ï¼Œå¾—åˆ†=+1

#### è½®æ¬¡è®¡æ•°æ–¹å¼

è½®æ¬¡æŒ‰ **user + assistant å¯¹**è®¡ç®—ï¼š

```
messagesæ•°ç»„:
  [0] system           <- è·³è¿‡
  [1] user (ç¬¬1è½®user)
  [2] assistant (ç¬¬1è½®assistant)  <- N=1 å¯¹åº”è¿™é‡Œ
  [3] user (ç¬¬2è½®user)
  [4] assistant (ç¬¬2è½®assistant)  <- N=2 å¯¹åº”è¿™é‡Œ
  [5] user (ç¬¬3è½®user)             <- æœ€åä¸€æ¡
```

### è¯„ä¼°é€»è¾‘

é»„é‡‘å†å²è¯„ä¼°ä¼šåˆ†åˆ«è¯„ä¼°ä¸åŒç±»å‹çš„è§„åˆ™ï¼š

#### single_turnè§„åˆ™
- **è¯„ä¼°å¯¹è±¡**ï¼šç”Ÿæˆçš„æœ€åä¸€æ¡assistantå›å¤
- **ç¤ºä¾‹**ï¼š`single_turn:sty:gratitude`
  - æ£€æŸ¥ç”Ÿæˆçš„å›å¤æ˜¯å¦ä½¿ç”¨äº†æ„Ÿè°¢ç”¨è¯­
  - å¦‚æœä½¿ç”¨ï¼Œå¾—åˆ†=-1

#### multi_turnè§„åˆ™
- **è¯„ä¼°å¯¹è±¡**ï¼šè¾“å…¥å†å²ä¸­ç¬¬Nè½®çš„assistantå›å¤
- **ç¤ºä¾‹**ï¼š`{"rule": "multi_turn:N_th:gender", "N": 2}`
  - ä»è¾“å…¥å†å²ä¸­æå–ç¬¬2è½®çš„assistantå›å¤
  - æ£€æŸ¥æ˜¯å¦è¯¢é—®äº†æ€§åˆ«
  - å¦‚æœè¯¢é—®ï¼Œå¾—åˆ†=+1

**å…³é”®åŒºåˆ«ï¼š**
- `single_turn` â†’ è¯„ä¼°**ç”Ÿæˆ**çš„å›å¤
- `multi_turn` â†’ è¯„ä¼°**å†å²**ä¸­çš„å›å¤

### è¾“å…¥æ ¼å¼

```json
{
  "key": "001",
  "messages": [
    {"role": "system", "content": "ç³»ç»Ÿæç¤ºè¯"},
    {"role": "user", "content": "ç”¨æˆ·æ¶ˆæ¯1"},
    {"role": "assistant", "content": "åŠ©æ‰‹å›å¤1"},
    {"role": "user", "content": "ç”¨æˆ·æ¶ˆæ¯2"},
    {"role": "assistant", "content": "åŠ©æ‰‹å›å¤2"},
    {"role": "user", "content": "ç”¨æˆ·æ¶ˆæ¯3"}  // æœ€åä¸€æ¡å¿…é¡»æ˜¯user
  ],
  "rule_list": [
    "single_turn:sty:gratitude",
    "single_turn:sty:explain_filler",
    {"rule": "multi_turn:N_th:consult_subject", "N": 1},
    {"rule": "multi_turn:N_th:gender", "N": 2}
  ]
}
```

**å…³é”®è¦æ±‚**ï¼š
- `messages` æ•°ç»„åŒ…å«å®Œæ•´å¯¹è¯å†å²
- æœ€åä¸€æ¡æ¶ˆæ¯**å¿…é¡»**æ˜¯ `user` æ¶ˆæ¯
- `rule_list` æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
  - **å­—ç¬¦ä¸²æ ¼å¼**ï¼šç”¨äº `single_turn` è§„åˆ™
    ```json
    "single_turn:sty:gratitude"
    ```
  - **å¯¹è±¡æ ¼å¼**ï¼šç”¨äº `multi_turn` è§„åˆ™ï¼ˆéœ€è¦æŒ‡å®šNå‚æ•°ï¼‰
    ```json
    {"rule": "multi_turn:N_th:gender", "N": 2}
    ```

**Nå‚æ•°è¯´æ˜**ï¼š
- å¯¹äº `multi_turn:N_th:xxx`ï¼šNè¡¨ç¤ºç¬¬å‡ è½®ï¼ˆä»1å¼€å§‹ï¼‰
  - ä¾‹å¦‚ï¼š`{"rule": "multi_turn:N_th:gender", "N": 2}` â†’ æ£€æŸ¥ç¬¬2è½®çš„assistantå›å¤
- å¯¹äº `multi_turn:FIRST_N:xxx`ï¼šNè¡¨ç¤ºå‰Nè½®
  - ä¾‹å¦‚ï¼š`{"rule": "multi_turn:FIRST_N:consult_subject", "N": 1}` â†’ æ£€æŸ¥å‰1è½®
- **è½®æ¬¡è®¡æ•°æ–¹å¼**ï¼šuser + assistant å¯¹ç®—ä¸€è½®
  - messages[1-2] = ç¬¬1è½®
  - messages[3-4] = ç¬¬2è½®
  - ä»¥æ­¤ç±»æ¨

### è¾“å‡ºæ ¼å¼

```json
{
  "key": "001",
  "generated_response": "æ¨¡å‹ç”Ÿæˆçš„æœ€åä¸€æ¡å›å¤",
  "evaluations": [
    {
      "rule": "single_turn:sty:gratitude",
      "triggered": true,
      "score": -1,
      "kwargs": {"phrase": "æ„Ÿè°¢"},
      "reason": "ä½¿ç”¨äº†æ„Ÿè°¢ç”¨è¯­"
    }
  ],
  "kwargs": [
    {"phrase": "æ„Ÿè°¢"},
    {"who": "family"}
  ]
}
```

### ä½¿ç”¨ç¤ºä¾‹

```python
from IBench.pipeline.json_context_evaluator import JsonContextEvaluator

# åˆå§‹åŒ–è¯„ä¼°å™¨
evaluator = JsonContextEvaluator(api_key="your-api-key")

# è¯„ä¼°
result = evaluator.evaluate_from_json(
    input_json_path="examples/golden_history_input_example.json",
    output_json_path="data/output/golden_history_result.json"
)

print(f"ç”Ÿæˆçš„å›å¤: {result['generated_response']}")
print(f"æ€»å¾—åˆ†: {sum(e['score'] for e in result['evaluations'])}")
```

---

## ğŸ”„ åŠ¨æ€äº¤äº’è¯„ä¼° (DynamicInteractiveEvaluator)

### ç”¨é€”
è¯„ä¼°å®Œæ•´å¯¹è¯è®°å½•çš„è´¨é‡ï¼Œæ”¯æŒFIRST_Nå’ŒN_thè§„åˆ™ç±»å‹ã€‚

### è¾“å…¥æ ¼å¼

```json
{
  "key": "001",
  "messages": [
    {"role": "user", "content": "...", "turn_id": 0},
    {"role": "assistant", "content": "...", "turn_id": 0},
    {"role": "user", "content": "...", "turn_id": 1},
    {"role": "assistant", "content": "...", "turn_id": 1}
  ],
  "rules": [
    {
      "rule_tag": "single_turn:sty:gratitude",
      "applied_turns": [0, 1, 2, 3, 4]
    },
    {
      "rule_tag": "multi_turn:FIRST_N:consult_subject",
      "N": 1
    },
    {
      "rule_tag": "multi_turn:N_th:gender",
      "N": 4
    }
  ]
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- `messages` åŒ…å«æ‰€æœ‰è½®æ¬¡çš„userå’Œassistantæ¶ˆæ¯
- æ¯æ¡æ¶ˆæ¯æœ‰ `turn_id` æ ‡è¯†è½®æ¬¡
- `rules` æ˜¯å¯¹è±¡æ•°ç»„ï¼Œæ”¯æŒï¼š
  - `applied_turns`: æŒ‡å®šè§„åˆ™åº”ç”¨çš„è½®æ¬¡
  - `N`: FIRST_Næˆ–N_thè§„åˆ™çš„å‚æ•°

### è¾“å‡ºæ ¼å¼

```json
{
  "key": "001",
  "evaluations": {
    "0": {
      "turn_id": 0,
      "response": "ç¬¬0è½®çš„å›å¤",
      "rules": [
        {
          "rule_tag": "multi_turn:N_th:consult_subject",
          "triggered": true,
          "score": 1,
          "kwargs": {"who": "family"}
        }
      ]
    }
  },
  "summary": {
    "total_score": 5,
    "total_turns": 5
  }
}
```

### ä½¿ç”¨ç¤ºä¾‹

```python
from IBench.pipeline.dynamic_interactive_eval import DynamicInteractiveEvaluator

# åˆå§‹åŒ–è¯„ä¼°å™¨
evaluator = DynamicInteractiveEvaluator(api_key="your-api-key")

# è¯„ä¼°
result = evaluator.evaluate_from_json(
    input_json_path="examples/dynamic_interactive_input_example.json",
    output_json_path="data/output/dynamic_interactive_result.json"
)

print(f"æ€»å¾—åˆ†: {result['summary']['total_score']}")
print(f"æ€»è½®æ¬¡: {result['summary']['total_turns']}")
```

---

## ğŸ—ï¸ è§„åˆ™ä½“ç³»

### è§„åˆ™å‘½åæ ¼å¼

#### å•è½®è§„åˆ™
```
single_turn:{category}:{rule_name}
```

ç¤ºä¾‹ï¼š
- `single_turn:sty:gratitude` - æ„Ÿè°¢ç”¨è¯­
- `single_turn:sty:explain_filler` - è§£é‡Šæ€§å¥—è¯
- `single_turn:med:forced_symptom` - å®½æ³›é—®è¯Š
- `single_turn:ask:multi_question` - å¤šä¸ªé—®é¢˜
- `single_turn:med:diagnosis_name` - ç–¾ç—…è¯Šæ–­

#### é˜¶æ®µè§„åˆ™ - FIRST_N
```
multi_turn:FIRST_N:{rule_name}
```

**å«ä¹‰**ï¼šåœ¨å‰Nè½®ä¸­**è‡³å°‘è§¦å‘ä¸€æ¬¡**å³é€šè¿‡

ç¤ºä¾‹ï¼š
- `multi_turn:FIRST_N:consult_subject` + `N=3`
  - åœ¨å‰3è½®ä¸­ä»»æ„ä¸€è½®è¯¢é—®å’¨è¯¢å¯¹è±¡å³å¾—åˆ†
  - å¦‚æœå‰3è½®éƒ½æ²¡è¯¢é—®ï¼Œåœ¨ç¬¬3è½®æœ«å°¾æ·»åŠ å¤±è´¥è®°å½•

#### é˜¶æ®µè§„åˆ™ - N_th
```
multi_turn:N_th:{rule_name}
```

**å«ä¹‰**ï¼šåœ¨ç¬¬Nè½®**å¿…é¡»è§¦å‘**

ç¤ºä¾‹ï¼š
- `multi_turn:N_th:gender` + `N=4`
  - åªåœ¨ç¬¬4è½®æ£€æŸ¥æ˜¯å¦è¯¢é—®æ€§åˆ«
  - é€šè¿‡å¾—+1åˆ†ï¼Œä¸é€šè¿‡å¾—0åˆ†

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
IBench/
â”œâ”€â”€ pipeline/
â”‚   â”œâ”€â”€ json_context_evaluator.py          # é»„é‡‘å†å²è¯„ä¼°å™¨
â”‚   â””â”€â”€ dynamic_interactive_eval.py        # åŠ¨æ€äº¤äº’è¯„ä¼°å™¨
â”‚
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ golden_history_input_example.json  # é»„é‡‘å†å²è¯„ä¼°è¾“å…¥ç¤ºä¾‹
â”‚   â”œâ”€â”€ golden_history_output_example.json # é»„é‡‘å†å²è¯„ä¼°è¾“å‡ºç¤ºä¾‹
â”‚   â”œâ”€â”€ dynamic_interactive_input_example.json   # åŠ¨æ€äº¤äº’è¯„ä¼°è¾“å…¥ç¤ºä¾‹
â”‚   â””â”€â”€ dynamic_interactive_output_example.json  # åŠ¨æ€äº¤äº’è¯„ä¼°è¾“å‡ºç¤ºä¾‹
â”‚
â”œâ”€â”€ rules/
â”‚   â”œâ”€â”€ single_rules.py                    # å•è½®è§„åˆ™å®šä¹‰
â”‚   â”œâ”€â”€ stage_rules.py                     # é˜¶æ®µè§„åˆ™å®šä¹‰
â”‚   â”œâ”€â”€ rule_mappings.py                   # è§„åˆ™æ˜ å°„é…ç½®
â”‚   â”œâ”€â”€ dynamic_rule_registry.py           # åŠ¨æ€è§„åˆ™æ³¨å†Œå™¨
â”‚   â””â”€â”€ kwargs_extractor.py                # å‚æ•°æå–å™¨
â”‚
â””â”€â”€ deprecated/                            # å·²åºŸå¼ƒçš„è¯„ä¼°å™¨
    â”œâ”€â”€ context_eval.py
    â”œâ”€â”€ interactive_eval.py
    â””â”€â”€ README.md
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é»„é‡‘å†å²è¯„ä¼°

```bash
# å‡†å¤‡è¾“å…¥JSONæ–‡ä»¶
cp examples/golden_history_input_example.json my_input.json

# è¿è¡Œè¯„ä¼°
python -c "
from IBench.pipeline.json_context_evaluator import JsonContextEvaluator
evaluator = JsonContextEvaluator(api_key='your-api-key')
result = evaluator.evaluate_from_json('my_input.json', 'my_output.json')
print(f'å®Œæˆï¼æ€»å¾—åˆ†: {sum(e[\"score\"] for e in result[\"evaluations\"])}')
"
```

### 2. åŠ¨æ€äº¤äº’è¯„ä¼°

```bash
# å‡†å¤‡è¾“å…¥JSONæ–‡ä»¶
cp examples/dynamic_interactive_input_example.json my_input.json

# è¿è¡Œè¯„ä¼°
python -c "
from IBench.pipeline.dynamic_interactive_eval import DynamicInteractiveEvaluator
evaluator = DynamicInteractiveEvaluator(api_key='your-api-key')
result = evaluator.evaluate_from_json('my_input.json', 'my_output.json')
print(f'å®Œæˆï¼æ€»å¾—åˆ†: {result[\"summary\"][\"total_score\"]}')
"
```

---

## ğŸ“š æ›´å¤šèµ„æº

- **è§„åˆ™è¯¦ç»†è¯´æ˜**: æŸ¥çœ‹ `docs/è¯„ä¼°Bench.md`
- **ç¤ºä¾‹æ–‡ä»¶**: æŸ¥çœ‹ `examples/` ç›®å½•
- **APIæ–‡æ¡£**: æŸ¥çœ‹å„ä¸ªè¯„ä¼°å™¨çš„docstring
- **è¿ç§»æŒ‡å—**: æŸ¥çœ‹ `deprecated/README.md`

---

## ğŸ’¡ é€‰æ‹©å“ªç§è¯„ä¼°æ¨¡å¼ï¼Ÿ

### ä½¿ç”¨é»„é‡‘å†å²è¯„ä¼°ï¼Œå¦‚æœï¼š
- éœ€è¦æµ‹è¯•æ¨¡å‹åœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­çš„å›å¤èƒ½åŠ›
- æœ‰å®Œæ•´çš„å¯¹è¯å†å²ï¼ˆåŒ…å«assistantå›å¤ï¼‰
- åªæƒ³è¯„ä¼°æœ€åä¸€æ¡ç”Ÿæˆçš„å›å¤
- æµ‹è¯•é›†æ˜¯ç‹¬ç«‹çš„"è€ƒé¢˜"

### ä½¿ç”¨åŠ¨æ€äº¤äº’è¯„ä¼°ï¼Œå¦‚æœï¼š
- éœ€è¦è¯„ä¼°å®Œæ•´å¯¹è¯çš„è´¨é‡
- å·²ç»æœ‰å®Œæ•´çš„å¯¹è¯è®°å½•
- éœ€è¦è¯„ä¼°æ¯ä¸€è½®çš„å›å¤
- éœ€è¦ä½¿ç”¨FIRST_Næˆ–N_thè§„åˆ™
- å…³æ³¨å¯¹è¯çš„è¿è´¯æ€§å’Œç­–ç•¥æ‰§è¡Œ

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆåºŸå¼ƒäº†ä»£ç æ–¹å¼çš„è¯„ä¼°å™¨ï¼Ÿ
A: JSONæ–¹å¼æ›´çµæ´»ï¼Œæ˜“äºé…ç½®å’Œå…±äº«ï¼Œä¹Ÿä¾¿äºæ‰¹é‡å¤„ç†å’Œç‰ˆæœ¬æ§åˆ¶ã€‚

### Q2: ä¸¤ç§è¯„ä¼°æ¨¡å¼å¯ä»¥æ··ç”¨å—ï¼Ÿ
A: å¯ä»¥ã€‚å…ˆç”¨é»„é‡‘å†å²è¯„ä¼°ç”Ÿæˆå›å¤ï¼Œå†ç”¨åŠ¨æ€äº¤äº’è¯„ä¼°å®Œæ•´å¯¹è¯ã€‚

### Q3: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰è§„åˆ™ï¼Ÿ
A: ç¼–è¾‘ `rules/rule_mappings.py`ï¼Œæ·»åŠ æ–°çš„è§„åˆ™æ˜ å°„å³å¯ã€‚

### Q4: kwargsæ˜¯å¦‚ä½•æå–çš„ï¼Ÿ
A: ä½¿ç”¨LLM judgeæˆ–å…³é”®è¯åŒ¹é…è‡ªåŠ¨æå–ï¼Œè¯¦è§ `rules/kwargs_extractor.py`ã€‚

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰ç–‘é—®ï¼Œè¯·æŸ¥é˜…é¡¹ç›®æ–‡æ¡£æˆ–æäº¤issueã€‚
