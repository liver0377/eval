# max_turns ä¿®å¤å®Œæˆæ€»ç»“

## âœ… ä¿®å¤å®Œæˆ

### **ä¿®å¤ä½ç½®**
**æ–‡ä»¶**ï¼š`pipeline/json_context_evaluator.py:362-367`

### **ä¿®å¤å†…å®¹**
```python
# ä¿®å¤å‰
max_turns = (len(messages) - start_idx) // 2

# ä¿®å¤å
# è€ƒè™‘æœ€åä¸€æ¡å•ç‹¬çš„ user æ¶ˆæ¯ï¼ˆGolden History è¯„ä¼°åœºæ™¯ï¼‰
# å¦‚æœæœ€åä¸€æ¡æ˜¯ userï¼Œè¯´æ˜æœ‰ä¸€è½®æœªå®Œæˆï¼Œåº”è¯¥è®¡å…¥ max_turns
if messages[-1].role == "user":
    max_turns = (len(messages) - start_idx + 1) // 2
else:
    max_turns = (len(messages) - start_idx) // 2
```

---

## ğŸ“Š Entry 004 éªŒè¯

### **æ•°æ®ç»“æ„**
```
æ€»æ¶ˆæ¯æ•°: 4
Index 0: system (turn_id=0)
Index 1: user (turn_id=1)
Index 2: assistant (turn_id=1)
Index 3: user (turn_id=2)  â† æœ€åä¸€æ¡
```

### **ä¿®å¤æ•ˆæœ**

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| max_turns | 1 | 2 |
| è§„åˆ™ N=2 | âŒ è¶…å‡ºèŒƒå›´ | âœ… æ­£å¸¸è¯„ä¼° |
| æ˜¯å¦æŠ¥é”™ | æ˜¯ | å¦ |

---

## ğŸ¯ ç°åœ¨ä¸¤å¤„éƒ½å·²ä¿®å¤

1. âœ… **`rules/dynamic_rule_registry.py:295-301`**
   - ç”¨é€”ï¼šN="auto" æ—¶æ£€æµ‹ precondition
   - çŠ¶æ€ï¼šå·²ä¿®å¤

2. âœ… **`pipeline/json_context_evaluator.py:362-367`**
   - ç”¨é€”ï¼šè¯„ä¼°å›ºå®š N å€¼çš„ multi_turn è§„åˆ™
   - çŠ¶æ€ï¼šå·²ä¿®å¤

---

## ğŸš€ æµ‹è¯•ç»“æœ

**ä¿®å¤å‰**ï¼š
```
âš  è­¦å‘Š: è®¡ç®—çš„ N=2 è¶…å‡ºèŒƒå›´ï¼ˆå®é™…1è½®ï¼‰ï¼Œè·³è¿‡è¯¥è§„åˆ™
âš  è­¦å‘Š: è®¡ç®—çš„ N=2 è¶…å‡ºèŒƒå›´ï¼ˆå®é™…1è½®ï¼‰ï¼Œè·³è¿‡è¯¥è§„åˆ™
âš  è­¦å‘Š: è®¡ç®—çš„ N=2 è¶…å‡ºèŒƒå›´ï¼ˆå®é™…1è½®ï¼‰ï¼Œè·³è¿‡è¯¥è§„åˆ™
```

**ä¿®å¤å**ï¼š
```
âœ“ æ­£ç¡®è¯†åˆ« max_turns = 2
âœ“ N=2 åœ¨èŒƒå›´å†…
âœ“ æ­£å¸¸è¯„ä¼°æ‰€æœ‰è§„åˆ™
```

---

## ğŸ“‹ å®Œæ•´ä¿®å¤è®°å½•

### **ä¿®å¤1ï¼šoffset é»˜è®¤å€¼**
- **æ–‡ä»¶**ï¼š`rules/dynamic_rule_registry.py:240`
- **ä¿®æ”¹**ï¼šoffset = 1 â†’ offset = 0

### **ä¿®å¤2ï¼šfind_precondition_turn çš„ max_turns**
- **æ–‡ä»¶**ï¼š`rules/dynamic_rule_registry.py:295-301`
- **ä¿®æ”¹**ï¼šæ·»åŠ å¯¹æœ€åä¸€æ¡ user æ¶ˆæ¯çš„å¤„ç†

### **ä¿®å¤3ï¼š_evaluate_multi_turn_rule çš„ max_turns**
- **æ–‡ä»¶**ï¼š`pipeline/json_context_evaluator.py:362-367`
- **ä¿®æ”¹**ï¼šæ·»åŠ å¯¹æœ€åä¸€æ¡ user æ¶ˆæ¯çš„å¤„ç†

---

**æ‰€æœ‰ä¿®å¤å·²å®Œæˆï¼ç°åœ¨å¯ä»¥æ­£ç¡®è¯„ä¼°æ‰€æœ‰è§„åˆ™äº†ã€‚** ğŸ‰
