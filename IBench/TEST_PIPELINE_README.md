# é»„é‡‘å†å²è¯„ä¼° Pipeline æµ‹è¯•è„šæœ¬

## ğŸ“ è¯´æ˜

è¿™ä¸ªæµ‹è¯•è„šæœ¬ç”¨äºéªŒè¯ IBench çš„é»„é‡‘å†å²è¯„ä¼°ï¼ˆGolden History Evaluationï¼‰pipeline æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

**è¦æ±‚**ï¼š
- âœ… å¿…é¡»é…ç½® API keyï¼ˆDASHSCOPE_API_KEY æˆ– OPENAI_API_KEYï¼‰
- âœ… ä½¿ç”¨çœŸå®çš„ API model è¿›è¡Œè¯„ä¼°
- âœ… ä» `golden_history_input.jsonl` è¯»å–ç¬¬ä¸€è¡Œä½œä¸ºæµ‹è¯•æ•°æ®

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è®¾ç½® API key

```bash
# Linux/Mac
export DASHSCOPE_API_KEY='your-api-key'

# æˆ–è€…ä½¿ç”¨ OpenAI API
export OPENAI_API_KEY='your-api-key'

# Windows
set DASHSCOPE_API_KEY=your-api-key
```

### 2. è¿è¡Œæµ‹è¯•

```bash
python test_golden_history_pipeline.py
```

## ğŸ“Š æµ‹è¯•å†…å®¹

æµ‹è¯•è„šæœ¬ä¼šéªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š

1. âœ… **æ•°æ®è¯»å–**ï¼šä» JSONL æ–‡ä»¶è¯»å–æµ‹è¯•æ•°æ®
2. âœ… **API key æ£€æŸ¥**ï¼šéªŒè¯ç¯å¢ƒå˜é‡ä¸­æ˜¯å¦é…ç½®äº† API key
3. âœ… **è¯„ä¼°å™¨åˆå§‹åŒ–**ï¼šåˆå§‹åŒ– JsonContextEvaluatorï¼ˆä½¿ç”¨ API modelï¼‰
4. âœ… **å›å¤ç”Ÿæˆ**ï¼šä½¿ç”¨ API model ç”Ÿæˆæœ€åä¸€æ¡å›å¤
5. âœ… **è§„åˆ™è¯„ä¼°**ï¼šè¯„ä¼°æ‰€æœ‰è§„åˆ™ï¼ˆsingle_turn å’Œ multi_turnï¼‰
6. âœ… **{N} æ›¿æ¢**ï¼šéªŒè¯ {N} å ä½ç¬¦æ˜¯å¦æ­£ç¡®æ›¿æ¢
7. âœ… **ç»“æœè¾“å‡º**ï¼šä¿å­˜è¯„ä¼°ç»“æœåˆ° JSON æ–‡ä»¶

## ğŸ“ è¾“å…¥è¾“å‡º

### è¾“å…¥
- **æµ‹è¯•æ•°æ®**ï¼š`data/dataset/golden_history_input.jsonl`ï¼ˆç¬¬ä¸€è¡Œï¼‰
- **è§„åˆ™åˆ—è¡¨**ï¼šåŒ…å« single_turn å’Œ multi_turn è§„åˆ™

### è¾“å‡º
- **ä¸´æ—¶æ–‡ä»¶**ï¼š
  - `temp_test_input.json` - ä¸´æ—¶è¾“å…¥æ–‡ä»¶
  - `temp_test_output.json` - ä¸´æ—¶è¾“å‡ºæ–‡ä»¶
- **æ§åˆ¶å°è¾“å‡º**ï¼š
  - ç”Ÿæˆçš„å›å¤
  - æ¯æ¡è§„åˆ™çš„è¯„ä¼°ç»“æœ
  - æ€»å¾—åˆ†

## ğŸ”§ æµ‹è¯•æ•°æ®ç¤ºä¾‹

ä» `golden_history_input.jsonl` è¯»å–çš„æ•°æ®æ ¼å¼ï¼š

```json
{
  "key": "001",
  "messages": [
    {"role": "system", "content": "è§’è‰²è®¾å®šï¼š..."},
    {"role": "user", "content": "å­©å­æ³¨æ„åŠ›ä¸é›†ä¸­"},
    {"role": "assistant", "content": "è¯·é—®å­©å­å¹´é¾„ï¼Ÿ"},
    ...
    {"role": "user", "content": "é‚£å¤ªå¥½äº†ï¼Œå…·ä½“æ€ä¹ˆæ“ä½œï¼Ÿæˆ‘æƒ³ç»™ä»–è¯•è¯•"}
  ],
  "rule_list": [
    "single_turn:sty:formula",
    {"rule": "single_turn:ask:multi_question", "N": 2},
    {"rule": "multi_turn:N_th:conv:ask_phone", "N": 8}
  ]
}
```

## ğŸ“‹ é¢„æœŸè¾“å‡º

### æˆåŠŸè¿è¡Œè¾“å‡º
```
================================================================================
é»„é‡‘å†å²è¯„ä¼° Pipeline æµ‹è¯•
================================================================================

ğŸ“‚ è¯»å–æµ‹è¯•æ•°æ®: data/dataset/golden_history_input.jsonl
âœ“ æˆåŠŸè¯»å–æµ‹è¯•æ•°æ®: key=001
  - æ¶ˆæ¯æ•°é‡: 17
  - è§„åˆ™æ•°é‡: 12

ğŸ”§ æ£€æŸ¥ API key...
âœ“ æ‰¾åˆ° API key: sk-xxxx...xxxx

ğŸš€ åˆå§‹åŒ–è¯„ä¼°å™¨...
âœ“ è¯„ä¼°å™¨åˆå§‹åŒ–æˆåŠŸ

ğŸš€ å¼€å§‹è¯„ä¼°...
âœ“ ä¸´æ—¶è¾“å…¥æ–‡ä»¶: /path/to/temp_test_input.json
âœ“ è¯„ä¼°å®Œæˆ

ğŸ“Š è¯„ä¼°ç»“æœ:
  - ç”Ÿæˆçš„å›å¤: å¥½çš„ï¼Œå»ºè®®æ‚¨å¸¦å­©å­åˆ°ä¸“ä¸šçš„å„¿ç«¥åŒ»é™¢è¿›è¡Œè¯¦ç»†æ£€æŸ¥...
  - æ€»å¾—åˆ†: 3

  è§„åˆ™è¯„ä¼°è¯¦æƒ…:
    âœ“ é€šè¿‡ | single_turn:sty:formula | å¾—åˆ†: 1 | æœªä½¿ç”¨å®¢æœå¥—è¯
    âœ“ é€šè¿‡ | single_turn:ask:multi_question | å¾—åˆ†: 1 | é—®é¢˜æ•°é‡ç¬¦åˆé˜ˆå€¼
    âœ— è¿è§„ | single_turn:sty:gratitude | å¾—åˆ†: -1 | ä½¿ç”¨äº†æ„Ÿè°¢ç”¨è¯­
    ...

âœ… æµ‹è¯•æˆåŠŸï¼Pipeline è¿è¡Œæ­£å¸¸
   è¯¦ç»†ç»“æœå·²ä¿å­˜åˆ°: /path/to/temp_test_output.json

================================================================================
âœ… æµ‹è¯•å®Œæˆï¼šPipeline è¿è¡Œæ­£å¸¸

ä¸‹ä¸€æ­¥ï¼š
1. æ‰¹é‡è¯„ä¼°ï¼šä½¿ç”¨ evaluate_batch_from_json()
2. è‡ªå®šä¹‰è§„åˆ™ï¼šæ·»åŠ æ–°çš„è¯„ä¼°è§„åˆ™
3. è°ƒæ•´é…ç½®ï¼šä¿®æ”¹ models/model_configs.py
================================================================================
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ‰¾ä¸åˆ°æµ‹è¯•æ•°æ®æ–‡ä»¶
```
âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æµ‹è¯•æ•°æ®æ–‡ä»¶: data/dataset/golden_history_input.jsonl
```

**è§£å†³æ–¹æ³•**ï¼šç¡®ä¿ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œè„šæœ¬

### é—®é¢˜ 2ï¼šAPI key æœªè®¾ç½®
```
âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° API key
   è¯·è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
   - Linux/Mac: export DASHSCOPE_API_KEY='your-api-key'
   - Windows: set DASHSCOPE_API_KEY=your-api-key
```

**è§£å†³æ–¹æ³•**ï¼š
- è®¾ç½®ç¯å¢ƒå˜é‡ `DASHSCOPE_API_KEY` æˆ– `OPENAI_API_KEY`
- é‡æ–°è¿è¡Œè„šæœ¬

### é—®é¢˜ 3ï¼šAPI è°ƒç”¨å¤±è´¥
```
âŒ è¯„ä¼°å¤±è´¥: API connection error
```

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- éªŒè¯ API key æ˜¯å¦æœ‰æ•ˆ
- æ£€æŸ¥ API é…é¢æ˜¯å¦ç”¨å®Œ
- æŸ¥çœ‹ `models/model_configs.py` ä¸­çš„ API é…ç½®

### é—®é¢˜ 4ï¼šæ¨¡å‹åŠ è½½å¤±è´¥
```
âŒ åˆå§‹åŒ–è¯„ä¼°å™¨å¤±è´¥: ...
```

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…ï¼š`pip install -r requirements.txt`
- æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼š`models/model_configs.py`
- æŸ¥çœ‹è¯¦ç»†é”™è¯¯å †æ ˆä¿¡æ¯

## ğŸ¯ ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼Œä½ å¯ä»¥ï¼š

1. **æ‰¹é‡è¯„ä¼°**ï¼šä½¿ç”¨ `evaluate_batch_from_json()` è¯„ä¼°æ•´ä¸ª JSONL æ–‡ä»¶
   ```python
   results = evaluator.evaluate_batch_from_json(
       input_json_paths=["data/dataset/golden_history_input.jsonl"],
       output_dir="data/output"
   )
   ```

2. **è‡ªå®šä¹‰è§„åˆ™**ï¼šæ·»åŠ æ–°çš„è§„åˆ™åˆ°è§„åˆ™æ³¨å†Œè¡¨
   - ä¿®æ”¹ `rules/rule_mappings.py`
   - åœ¨ `rules/single_rules.py` æˆ– `rules/stage_rules.py` ä¸­å®ç°è§„åˆ™

3. **è°ƒæ•´é…ç½®**ï¼šä¿®æ”¹ `models/model_configs.py` ä¸­çš„é…ç½®
   - æ›´æ¢æ¨¡å‹
   - è°ƒæ•´ API å‚æ•°
   - ä¿®æ”¹è¶…æ—¶è®¾ç½®

4. **æŸ¥çœ‹è¯¦ç»†ç»“æœ**ï¼šæ£€æŸ¥è¾“å‡ºçš„ JSON æ–‡ä»¶
   - `temp_test_output.json` - åŒ…å«å®Œæ•´çš„è¯„ä¼°ç»“æœ
   - åŒ…æ‹¬ç”Ÿæˆçš„å›å¤ã€æ¯æ¡è§„åˆ™çš„è¯„ä¼°ç»“æœã€kwargs ç­‰

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [è¯„ä¼°ä½“ç³»è¯´æ˜](docs/è¯„ä¼°ä½“ç³»è¯´æ˜.md)
- [è§„åˆ™æ–‡æ¡£](docs/è¯„ä¼°Bench.md)
- [README](README.md)
