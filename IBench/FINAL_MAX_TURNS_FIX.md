# max_turns è®¡ç®—ä¿®å¤ - æœ€ç»ˆç‰ˆæœ¬

## âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

### **é—®é¢˜æ ¹æº**
ä¹‹å‰çš„ä¿®å¤åœ¨ `_evaluate_multi_turn_rule` ä¸­é”™è¯¯åœ°æ·»åŠ äº† "+1"ï¼Œå¯¼è‡´ max_turns åŒ…å«äº†æœªå®Œæˆçš„è½®æ¬¡ã€‚

### **æ­£ç¡®çš„ç†è§£**

#### **find_precondition_turn**ï¼ˆä¿æŒä¸å˜ï¼‰
```python
# ç”¨äº N="auto" æ—¶æ‰«æprecondition
# éœ€è¦æ£€æŸ¥æœ€åä¸€è½®çš„useræ¶ˆæ¯
if messages[-1].role == "user":
    max_turns = (len(messages) - start_idx + 1) // 2  # âœ… æ­£ç¡®
```

#### **_evaluate_multi_turn_rule**ï¼ˆéœ€è¦ä¿®å¤ï¼‰
```python
# ç”¨äºè¯„ä¼°å›ºå®š N å€¼çš„è§„åˆ™
# åªè¯„ä¼°å†å²ä¸­çš„å›å¤ï¼Œä¸åŒ…å«å³å°†ç”Ÿæˆçš„å›å¤
max_turns = (len(messages) - start_idx) // 2  # âœ… æ­£ç¡®ï¼ˆç§»é™¤+1ï¼‰
```

---

## ğŸ”§ ä¿®å¤å†…å®¹

### **ä¿®å¤1ï¼šç§»é™¤é”™è¯¯çš„ "+1"**
**æ–‡ä»¶**ï¼š`pipeline/json_context_evaluator.py:362-367`

**ä¿®æ”¹å‰**ï¼š
```python
if messages[-1].role == "user":
    max_turns = (len(messages) - start_idx + 1) // 2  # âŒ é”™è¯¯
else:
    max_turns = (len(messages) - start_idx) // 2
```

**ä¿®æ”¹å**ï¼š
```python
# åªè®¡ç®—å®Œæ•´è½®æ•°ï¼ˆå·²æœ‰ assistant å›å¤çš„è½®æ¬¡ï¼‰
max_turns = (len(messages) - start_idx) // 2  # âœ… æ­£ç¡®
```

---

### **ä¿®å¤2ï¼šæ”¹è¿›è¾¹ç•Œæ£€æŸ¥**
**æ–‡ä»¶**ï¼š`pipeline/json_context_evaluator.py:369-376`

**ä¿®æ”¹å‰**ï¼š
```python
if assistant_idx >= len(messages):
    print(f"âš  è­¦å‘Š: è®¡ç®—çš„ N={resolved_N} è¶…å‡ºèŒƒå›´ï¼ˆå®é™…{max_turns}è½®ï¼‰")
    return {...}
```

**ä¿®æ”¹å**ï¼š
```python
if assistant_idx >= len(messages):
    # åŒºåˆ†ä¸¤ç§æƒ…å†µ
    if assistant_idx == len(messages) and messages[-1].role == "user":
        # ç‰¹æ®Šæƒ…å†µï¼šNæŒ‡å‘å³å°†ç”Ÿæˆçš„å›å¤ï¼ˆGolden History åœºæ™¯ï¼‰
        print(f"â„¹ï¸  ä¿¡æ¯: è§„åˆ™ N={resolved_N} æŒ‡å‘å³å°†ç”Ÿæˆçš„å›å¤ï¼Œè·³è¿‡è¯¥è§„åˆ™")
        return {
            "triggered": False,
            "score": 0,
            "kwargs": {},
            "reason": f"è§„åˆ™ N={resolved_N} æŒ‡å‘å³å°†ç”Ÿæˆçš„å›å¤ï¼Œå†å²ä¸­ä¸å­˜åœ¨"
        }
    else:
        # çœŸæ­£çš„è¶…å‡ºèŒƒå›´
        print(f"âš  è­¦å‘Š: è®¡ç®—çš„ N={resolved_N} è¶…å‡ºèŒƒå›´ï¼ˆå®é™…{max_turns}è½®ï¼‰ï¼Œè·³è¿‡è¯¥è§„åˆ™")
        return {
            "triggered": False,
            "score": 0,
            "kwargs": {},
            "reason": f"N={resolved_N} è¶…å‡ºèŒƒå›´ï¼Œå¯¹è¯ä»…æœ‰{max_turns}è½®"
        }
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### **åœºæ™¯ï¼š8æ¡æ¶ˆæ¯ï¼ˆsystem + 3å¯¹ + æœ€åuserï¼‰**

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| len(messages) | 8 | 8 |
| start_idx | 1 | 1 |
| max_turns | (8-1+1)//2 = 4 | (8-1)//2 = 3 |
| å®é™…å®Œæ•´è½®æ•° | 3 | 3 |
| N=5 çš„è¡Œä¸º | âŒ "N=5 è¶…å‡ºèŒƒå›´ï¼ˆå®é™…4è½®ï¼‰" | âœ… "æŒ‡å‘å³å°†ç”Ÿæˆçš„å›å¤ï¼Œè·³è¿‡" |

---

## ğŸ¯ æœ€ç»ˆè¡Œä¸º

### **ä¸åŒ N å€¼çš„å¤„ç†**

1. **N <= max_turns**ï¼ˆå¦‚ N=1,2,3ï¼‰
   - âœ… æ­£å¸¸è¯„ä¼°å†å²ä¸­çš„å›å¤

2. **N == max_turns + 1**ï¼ˆå¦‚ N=4ï¼ŒæŒ‡å‘å³å°†ç”Ÿæˆçš„å›å¤ï¼‰
   - âœ… å‹å¥½æç¤º"æŒ‡å‘å³å°†ç”Ÿæˆçš„å›å¤"
   - ä¸ä¼šæŠ¥é”™

3. **N > max_turns + 1**ï¼ˆå¦‚ N=6ï¼ŒçœŸçš„è¶…å‡ºèŒƒå›´ï¼‰
   - âš  è­¦å‘Š"è¶…å‡ºèŒƒå›´"

---

## âœ… éªŒè¯è¦ç‚¹

- âœ… max_turns æ­£ç¡®åæ˜ å®Œæ•´è½®æ•°
- âœ… ä¸å†å‡ºç°"N=5 è¶…å‡ºèŒƒå›´ï¼ˆå®é™…5è½®ï¼‰"çš„çŸ›ç›¾
- âœ… å‹å¥½åŒºåˆ†"å³å°†ç”Ÿæˆçš„å›å¤"å’Œ"çœŸæ­£çš„è¶…å‡ºèŒƒå›´"
- âœ… ä¿ç•™äº† find_precondition_turn çš„ "+1"ï¼ˆéœ€è¦æ‰«ææœ€åuseræ¶ˆæ¯ï¼‰

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰
