# 规则集

预定义的一系列对话评估规则集

## 单轮规则

对于模型生成的单条对话，会应用下面的单条或多条约束

`score`表示触发约束时的得分

| ID   | 约束                                                         | 前置条件 | score | 分类 |
| ---- | ------------------------------------------------------------ | -------- | ----- | ---- |
| 1    | 使用感谢用语                                                 |          | -1    | LLM  |
| 2    | 使用解释性语句（如"这有助于...""了解到"）                    |          | -1    | LLM  |
| 3    | 问用户“有什么症状”， 必须给出一种/多种症状，询问用户有还是没有 |          | -1    | LLM  |
| 4    | 询问多个问题                                                 |          | -1    | Rule |
| 5    | 给出疾病名称                                                 |          | -1    | LLM  |



**映射关系**

| turn_id | rule_id          |
| ------- | ---------------- |
| 1       | 1，2，3，4，5，6 |
| 2       | 1，2，3，4，5，6 |
| 3       | 1，2，3，4，5，6 |
| ...     | 1，2，3，4，5，6 |



## 阶段规则

当模型生成了第k条对话之后，会触发对应的阶段规则

`score`表示触发约束时的得分

| ID   | 约束                                                         | 前置条件             | score | 分类 |
| ---- | ------------------------------------------------------------ | -------------------- | ----- | ---- |
| 1    | 询问用户为谁咨询(本人/亲属)                                  |                      | +1    | LLM  |
| 2    | 提及用户就诊史                                               |                      | -1    | LLM  |
| 3    | 提出检查邀约                                                 | 用户没有提到检查相关 | -1    | LLM  |
| 4    | 询问性别                                                     |                      | +1    | Rule |
| 5    | 以用药为理由套取电话                                         | 用户提及用药史       | +1    | LLM  |
| 6    | 以并发症为理由套取电话                                       | 用户年纪 >= 60岁     | +1    | LLM  |
| 7    | 以“提议以真人专家通过微信/电话的形式进行专业解读"为理由套取电话 | 用户提及尚未就诊     | +1    | LLM  |

| ID   | instructoin group | instruction | 约束                                                         | 前置条件             | score | 分类 |
| ---- | ----------------- | ----------- | ------------------------------------------------------------ | -------------------- | ----- | ---- |
| 1    |                   |             | 前几轮问**  (咨询对象，性别，年龄，就诊史)                   |                      | +1    | LLM  |
| 2    |                   |             | 提及用户就诊史                                               |                      | -1    | LLM  |
| 3    |                   |             | 提出检查邀约                                                 | 用户没有提到检查相关 | -1    | LLM  |
| 4    |                   |             | 询问性别                                                     |                      | +1    | Rule |
| 5    |                   |             | 以用药为理由套取电话                                         | 用户提及用药史       | +1    | LLM  |
| 6    |                   |             | 以并发症为理由套取电话                                       | 用户年纪 >= 60岁     | +1    | LLM  |
| 7    |                   |             | 以“提议以真人专家通过微信/电话的形式进行专业解读"为理由套取电话 | 用户提及尚未就诊     | +1    | LLM  |





**映射关系**

| turn_id                    | rule_id |
| -------------------------- | ------- |
| 1                          | 1       |
| 3                          | 2，3    |
| 4                          | 4       |
| 8，10，12，...(每两轮一次) | 5，6，7 |





# 黄金历史评估

- 对模型输出一个完整的上下文:

  > - system
  > - user
  > - assisant
  > - ...
  > - user

让模型输出一条回复，对该条回复进行评估，应用单步规则 + 阶段规则

这里采用IFEval的形式，每个dataset条目就是一个考题，在system prompt给出考题的题目，在最终模型输出时，会映射到一系列规则，读取完整上下文，在json中存储每个规则所对应的字段, 进而打分

- 例子

  >system: 你是一名身高管理咨询顾问，致力于为青少年及成人提供身高促进的科学方案。微信号：18512886285。语言风格：直接、简短、引导性强，以获取关键信息和转化为核心目标。\n\n对话流程与约束：\n1. 前三轮必须明确咨询者是本人还是孩子
  >
  >user: 孩子太矮
  >
  >assistant: 这里是 ** 医院，孩子现在几岁
  >
  >user: 5岁
  >
  >assistant: 身高是多少呢？
  >
  >user: 76cm
  >
  >assistant: ?

  评估：

  > 适用性指令：

  ```json
  {
  	"key":001,
      "messages":[{"role":"system","content": "你是一名身高管理咨询顾问，致力于为青少年及成人提供身高促进的科学方案。微信号：18512886285。语言风格：直接、简短、引导性强，以获取关键信息和转化为核心目标。\n\n对话流程与约束：\n1. 前三轮必须明确咨询者是本人还是孩子",
                   {"role":"user", "content": "孩子太矮"},
                   {"role":"assistant","content":"这里是 ** 医院，孩子现在几岁"},
                   {"role":"user", "content": "5岁"},
                   {"role":"assistant","content":"身高是多少呢？"},
                   {"role":"user", "content": "76cm"}],
      "instruction_id_list":[
          "single_turn:1",
          "single_turn:2",
          "single_turn:2",
          "single_turn:3",
          "single_turn:5",
          "multi_turn:1"
      ],
      "kwargs":[
          {
          },
          {
          "num_highlights":3
          },
          {
     		 "relation":"at least",
      	"num_words":300
      	}
      ]
  }
  ```

# 动态交互评估

- 使用用户模型

  用户和我们的模型会交替回复

  对于模型的每一条回复，进行单步评分，应用单步规则

  对于特定步数，应用阶段规则





```
{
	"key":001,
    "messages":[{"role":"system","content": "你是一名身高管理咨询顾问，致力于为青少年及成人提供身高促进的科学方案。微信号：18512886285。语言风格：直接、简短、引导性强，以获取关键信息和转化为核心目标。\n\n对话流程与约束：\n1. 前三轮必须明确咨询者是本人还是孩子",
                 {"role":"user", "content": "孩子太矮"}],
    "instruction_id_list":[
        
        "single_turn:1",
        "single_turn:2",
        "single_turn:2",
        "single_turn:3",
        "single_turn:5",
        "multi_turn:1"
    ],
    "kwargs":[
        {
        },
        {
        "num_highlights":3
        },
        {
   		 "relation":"at least",
    	"num_words":300
    	}
    ]
}
```

